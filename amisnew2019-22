1. to get amis and snapshot details
---------------------------------------
#!/bin/bash

# Define the regions to check
regions=("us-east-1" "eu-west-1" "eu-west-2")
# Define the date range
start_date="2019-01-01T00:00:00Z"
end_date="2022-12-31T23:59:59Z"
# Output CSV file
output_file="ami_snapshots_details.csv"

# Create CSV header
echo "Region,AMI ID,AMI Description,Creation Date,Snapshot ID,Snapshot Description,Snapshot Start Time,Volume ID" > $output_file

# Loop through each region
for region in "${regions[@]}"
do
  echo "Fetching AMIs in region: $region"
  
  # Describe images and filter by creation date and owner
  ami_data=$(aws ec2 describe-images \
    --region $region \
    --owners self \
    --query "Images[?CreationDate>='$start_date' && CreationDate<='$end_date'].[ImageId,Description,CreationDate,BlockDeviceMappings[*].Ebs.SnapshotId]" \
    --output text)
  
  # Check if there are AMIs found
  if [ -n "$ami_data" ]; then
    while IFS=$'\t' read -r ami_id ami_description creation_date snapshot_ids
    do
      # Extract each snapshot ID associated with the AMI
      snapshot_ids=($snapshot_ids)
      for snapshot_id in "${snapshot_ids[@]}"; do
        # Fetch snapshot details
        snapshot_data=$(aws ec2 describe-snapshots \
          --region $region \
          --snapshot-ids $snapshot_id \
          --query "Snapshots[].[SnapshotId,Description,StartTime,VolumeId]" \
          --output text)
        
        if [ -n "$snapshot_data" ]; then
          while IFS=$'\t' read -r snapshot_id snapshot_description snapshot_start_time volume_id
          do
            # Write AMI and snapshot data to CSV file
            echo "$region,$ami_id,\"$ami_description\",$creation_date,$snapshot_id,\"$snapshot_description\",$snapshot_start_time,$volume_id" >> $output_file
          done <<< "$snapshot_data"
        else
          echo "No snapshot details found for Snapshot ID: $snapshot_id in region: $region"
        fi
      done
    done <<< "$ami_data"
  else
    echo "No AMIs found in region: $region between $start_date and $end_date"
  fi
done

echo "AMI and snapshot details saved to $output_file."
